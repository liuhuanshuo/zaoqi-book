#!/usr/bin/env python
# coding: utf-8

# # è‚¡ç¥¨æ•°æ®åˆ†æ
# 
# ```{admonition} åœ¨çº¿åˆ·é¢˜
# :class: seealso
# 
# æ£€æŸ¥ or å¼ºåŒ– `Pandas` æ•°æ®åˆ†ææ“ä½œï¼Ÿ<a href="https://www.heywhale.com/mw/project/6146c0318447b8001769ff20" target="_blank">ğŸ‘‰åœ¨çº¿ä½“éªŒã€ŒPandasè¿›é˜¶ä¿®ç‚¼300é¢˜ã€</a>
# ```
# 
# ```{note} 
# æœ¬é¡µé¢ä»£ç å¯ä»¥[åœ¨çº¿ç¼–è¾‘ã€æ‰§è¡Œ](../æŒ‡å¼•/åœ¨çº¿æ‰§è¡Œ.md)ï¼
# ```

# ## æœ¬é¡µé¢æ•°æ®è¯´æ˜
# 
# 
# ä¸ºäº†æ›´å¥½çš„ä»‹ç»ç›¸å…³æ“ä½œï¼Œæœ¬é¡µé¢ä½¿ç”¨ **æŸè‚¡ç¥¨æ•°æ®** æ•°æ®è¿›è¡Œå±•å¼€ï¼Œä½ åº”è¯¥å¯¹æ•°æ®å­—æ®µã€æ•°å€¼ã€ç±»å‹ç­‰ç›¸å…³ä¿¡æ¯åšä¸€ä¸ªå¤§è‡´äº†è§£ï¼

# In[1]:


import pandas as pd
import warnings
warnings.filterwarnings("ignore")
df1 = pd.read_csv("000001_daily.csv")
df2 = pd.read_csv("000001_5min.csv")
df1.head()


# ## æ—¶é—´ç±»å‹è½¬æ¢
# 
# å°† df1 å’Œ df2 çš„ æ—¥æœŸ åˆ—è½¬æ¢ä¸º pandas æ”¯æŒçš„æ—¶é—´æ ¼å¼

# In[2]:


df1['æ—¥æœŸ'] = pd.to_datetime(df1['æ—¥æœŸ'])
df2['æ—¶é—´'] = pd.to_datetime(df2['æ—¶é—´'])
# df1['æ—¥æœŸ'] = df1['æ—¥æœŸ'].astype('datetime64[ns]')


# ## æ—¥æœŸç­›é€‰

# ### æŒ‰åŒºé—´ç­›é€‰
# 
# ç­›é€‰å‡º df2 æ—¶é—´åœ¨ `2021-08-03 09:35:00` ä¸ `2021-08-04 15:00:00` ä¹‹é—´çš„æ•°æ®

# In[3]:


df2[(df2['æ—¶é—´'] > '2021-08-03 09:35:00') & (df2['æ—¶é—´'] < '2021-08-04 15:00:00')]


# ### æŒ‰æŒ‡å®šæ—¶é—´ç­›é€‰
# 
# ç­›é€‰ df2 æ—¶é—´ä¸º 2021-08-03 çš„å…¨éƒ¨æ•°æ®

# In[4]:


df2.set_index('æ—¶é—´').truncate(after=pd.Timestamp('2021-08-04'))


# ## é‡‘èè®¡ç®—

# ### æ¶¨è·Œé¢
# 
# `df1` æ–°å¢ä¸€åˆ— æ¶¨è·Œï¼Œè®¡ç®—å‰åä¸¤æ—¥æ”¶ç›˜ä»·ä¹‹å·®
# 
# æ³¨æ„ï¼šè™½ç„¶æˆ‘ä»¬çš„df1åŒ…å«æ¶¨è·Œé¢åˆ—ï¼Œä½†æ˜¯è¿™ä¸ªæ“ä½œå¾ˆå¸¸ç”¨ï¼Œæ‰€ä»¥ç»ƒä¹ ä¸€ä¸‹

# In[5]:


df1['æ¶¨è·Œ']  = df1.æ”¶ç›˜.diff()


# ### æ¶¨è·Œå¹…
# 
# `df1` æ–°å¢ä¸€åˆ— æ¶¨è·Œå˜åŒ–ç‡ï¼Œè®¡ç®—å‰åä¸¤æ—¥æ”¶ç›˜ä»·ä¹‹å·®çš„å˜åŒ–ç‡
# 
# æ³¨æ„ï¼šè™½ç„¶æˆ‘ä»¬çš„df1åŒ…å«æ¶¨è·Œå¹…åˆ—ï¼Œä½†æ˜¯è¿™ä¸ªæ“ä½œå¾ˆå¸¸ç”¨ï¼Œæ‰€ä»¥ç»ƒä¹ ä¸€ä¸‹ï¼Œç»“æœå¯ä»¥ç”¨äºéªŒè¯

# In[6]:


df1['æ¶¨è·Œå˜åŒ–ç‡'] = (df1.æ”¶ç›˜.pct_change()).apply(lambda x: format(x, '.2%'))


# ### ç§»åŠ¨å‡å€¼
# 
# è®¡ç®—æ”¶ç›˜ä»·çš„5æ—¥ç§»åŠ¨å‡çº¿

# In[7]:


df1.æ”¶ç›˜.rolling(window=5).mean()


# ### ç§»åŠ¨å‡å€¼ï¼ˆå¯è§†åŒ–ï¼‰
# 
# è®¡ç®—å¹¶ç»˜åˆ¶æ”¶ç›˜ä»·çš„5æ—¥ç§»åŠ¨å‡çº¿

# In[8]:


df1.æ”¶ç›˜.rolling(window=5).mean().plot()


# ### ç§»åŠ¨å‡å€¼ï¼ˆå¯è§†åŒ–ï¼‰
# 
# åŒæ—¶è®¡ç®—å¹¶ç»˜åˆ¶ df1 çš„æ”¶ç›˜ä»·ã€5æ—¥å‡çº¿ã€20æ—¥å‡çº¿

# In[9]:


df1.set_index("æ—¥æœŸ")['æ”¶ç›˜'].plot()
df1.set_index("æ—¥æœŸ")['æ”¶ç›˜'].rolling(5).mean().plot()
df1.set_index("æ—¥æœŸ")['æ”¶ç›˜'].rolling(20).mean().plot()


# ### æŒ‡æ•°ç§»åŠ¨å¹³å‡å€¼ï¼ˆEMAï¼‰
# 
# æ ¹æ® df1 è®¡ç®— EMA20

# In[10]:


df1['EMA20'] = df1['æ”¶ç›˜'].ewm(span=20,min_periods=0,adjust=False,ignore_na=False).mean()


# ### MACD
# 
# è®¡ç®— df1 çš„ MACD æŒ‡æ ‡

# In[11]:


exp1 = df1['æ”¶ç›˜'].ewm(span=12, adjust=False).mean()
exp2 = df1['æ”¶ç›˜'].ewm(span=26, adjust=False).mean()
df1['MACD'] = exp1 - exp2
df1['Signal line'] = df1['MACD'].ewm(span=9, adjust=False).mean()


# ### å¸ƒæ—æŒ‡æ ‡
# 
# è®¡ç®—å¹¶ç»˜åˆ¶å¸ƒæ—æŒ‡æ ‡ï¼Œè®¡ç®—æ–¹æ³•å‚è€ƒ[ç™¾åº¦ç™¾ç§‘](https://baike.baidu.com/item/%E5%B8%83%E6%9E%97%E7%BA%BF%E6%8C%87%E6%A0%87/3325894?fromtitle=%E5%B8%83%E6%9E%97%E6%8C%87%E6%A0%87&fromid=258891&fr=aladdin)
# 

# In[12]:


df1['former 30 days rolling Close mean'] = df1['æ”¶ç›˜'].rolling(20).mean()
df1['upper bound'] = df1['former 30 days rolling Close mean'] +     2*df1['æ”¶ç›˜'].rolling(20).std()  # åœ¨è¿™é‡Œæˆ‘ä»¬å–20å¤©å†…çš„æ ‡å‡†å·®
df1['lower bound'] = df1['former 30 days rolling Close mean'] -     2*df1['æ”¶ç›˜'].rolling(20).std()

import matplotlib.pyplot as plt

plt.rcParams['font.sans-serif'] = ['Songti SC'] #è®¾ç½®ä¸­æ–‡ï¼Œå¦‚æœæœ¬å¥ä»£ç å¯¼è‡´å¤±æ•ˆï¼Œå¯ä»¥ç‚¹å‡»https://mp.weixin.qq.com/s/WKOGvQP-6QUAP00ZXjhweg

df1.set_index("æ—¥æœŸ")[['æ”¶ç›˜', 'former 30 days rolling Close mean','upper bound','lower bound' ]].plot(figsize=(16, 6))

plt.show()


# ## æ—¥æœŸç§»åŠ¨

# ### ç§»åŠ¨å€¼
# 
# å°† df1 çš„ç´¢å¼•è®¾ç½®ä¸ºæ—¥æœŸï¼Œå°† df1 æ•°æ®å‘åç§»åŠ¨ä¸€å¤©

# In[13]:


df1.set_index('æ—¥æœŸ').shift(1)


# ### ç§»åŠ¨ç´¢å¼•
# 
# å°† df1 çš„ç´¢å¼•è®¾ç½®ä¸ºæ—¥æœŸï¼Œå¹¶å°†å…¨éƒ¨æ—¥æœŸå‘åç§»åŠ¨ä¸€å¤©

# In[14]:


import datetime
df1.set_index('æ—¥æœŸ').shift(freq=datetime.timedelta(1))


# ## æ—¥æœŸé‡é‡‡æ ·

# ### æ—¥ -> å‘¨
# 
# æŒ‰å‘¨å¯¹ df1 è¿›è¡Œé‡é‡‡æ ·ï¼Œä¿ç•™æ¯å‘¨æœ€åä¸€ä¸ªæ•°æ®

# In[15]:


df1.set_index('æ—¥æœŸ').resample('W').last()


# ### æ—¥ -> æœˆ
# 
# æŒ‰æœˆå¯¹ df1 è¿›è¡Œé‡é‡‡æ ·ï¼Œä¿ç•™æ¯æœˆæœ€åä¸€ä¸ªæ•°æ®

# In[16]:


df1.set_index('æ—¥æœŸ').resample('M').last()


# ### åˆ†é’Ÿ -> æ—¥
# 
# æŒ‰æ—¥å¯¹ df2 è¿›è¡Œé‡é‡‡æ ·ï¼Œä¿ç•™æ¯å¤©æœ€åä¸€ä¸ªæ•°æ®

# In[17]:


df2.set_index('æ—¶é—´').resample('D').last()


# ### ä½é¢‘ -> é«˜é¢‘
# 
# å°† df2 çš„ 5åˆ†é’Ÿ æ•°æ®æ”¹ä¸º 3åˆ†é’Ÿï¼Œç¼ºå¤±æ•°æ®å‘å‰å¡«å……

# In[18]:


df_3min = df2.set_index('æ—¶é—´').resample('3min').last()
df_3min.ffill()

